name: Build Lyridan

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Run build.bat
        shell: cmd
        run: |
          echo. | call build.bat

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Lyridan-Windows
          path: dist/Lyridan.exe

  build-macos:
    name: Build for macOS
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip uninstall -y tkinterdnd2 || true
          pip install tkinterdnd2-universal

      - name: Run build.command
        run: |
          chmod +x build.command
          echo "" | ./build.command

      - name: Create DMG
        run: |
          # 1. Check what PyInstaller created in dist/
          echo "Listing dist directory..."
          ls -R dist/

          # 2. Define names
          VOLNAME="Lyridan"
          DMG_NAME="Lyridan.dmg"
          
          # 3. prepare a folder to be turned into the DMG
          mkdir -p dist/dmg_content

          if [ -d "dist/Lyridan.app" ]; then
            # If a .app bundle exists, copy it to the staging folder
            echo "Found Lyridan.app, preparing for DMG..."
            cp -r "dist/Lyridan.app" dist/dmg_content/
          elif [ -f "dist/Lyridan" ]; then
            # If only a binary exists, move it to the staging folder
            echo "Found Lyridan binary, preparing for DMG..."
            cp "dist/Lyridan" dist/dmg_content/
          else
            echo "Error: Could not find 'Lyridan.app' or 'Lyridan' in dist/."
            exit 1
          fi

          # 4. Create the DMG from the content folder using hdiutil (native macOS tool)
          hdiutil create -volname "$VOLNAME" -srcfolder "dist/dmg_content" -ov -format UDZO "dist/$DMG_NAME"
          
          echo "DMG Created successfully."

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Lyridan-macOS
          path: dist/Lyridan.dmg
