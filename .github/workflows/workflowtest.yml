name: Workflow Test Build

on:
  push:
    branches: [ "workflowtest" ]
  workflow_dispatch: # Allows you to run this manually from the Actions tab

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Bump Version and Timestamp
      shell: python
      run: |
        import re
        import os
        from datetime import datetime, timezone

        # --- CONFIGURATION ---
        run_num = os.environ.get('GITHUB_RUN_NUMBER', '0')
        compile_datetime = datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC')

        # --- REGEX PATTERNS ---
        # For maccompile.py: version = "1.1.0"
        mac_ver_pattern = re.compile(r"(version\s*=\s*)(['\"])([^'\"]+)(['\"])", re.IGNORECASE)
        # For maccompile.py: COPYRIGHT = "..."
        copyright_pattern = re.compile(r"(COPYRIGHT\s*=\s*)(['\"])([^'\"]+)(['\"])", re.IGNORECASE)
        # For gui.py: ...version 1.1.0
        gui_ver_pattern = re.compile(r"(Made by Elevatorisbest.*?version\s+)([\d\.]+)")

        # --- FILE PROCESSING ---
        files_to_update = ['gui.py', 'maccompile.py']

        for file_path in files_to_update:
            if not os.path.exists(file_path):
                print(f"Skipping {file_path} (not found)")
                continue
            
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()

            updated = False
            
            # --- Logic for maccompile.py ---
            if 'maccompile.py' in file_path:
                # Update version variable
                match = mac_ver_pattern.search(content)
                if match:
                    prefix, quote_start, current_ver, quote_end = match.groups()
                    clean_ver = current_ver.split('-')[0]
                    new_ver = f"{clean_ver}.{run_num}-DEV"
                    content = content.replace(match.group(0), f"{prefix}{quote_start}{new_ver}{quote_end}")
                    print(f"Updated {file_path} VERSION: {current_ver} -> {new_ver}")
                    updated = True

                # Update copyright with timestamp
                match = copyright_pattern.search(content)
                if match:
                    prefix, quote_start, current_copyright, quote_end = match.groups()
                    new_copyright = f"{current_copyright} | Compiled on {compile_datetime}"
                    content = content.replace(match.group(0), f"{prefix}{quote_start}{new_copyright}{quote_end}")
                    print(f"Updated {file_path} COPYRIGHT with timestamp.")
                    updated = True

            # --- Logic for gui.py ---
            if 'gui.py' in file_path:
                match = gui_ver_pattern.search(content)
                if match:
                    prefix, current_ver = match.groups()
                    # We need the new_ver from the maccompile logic, so let's calculate it again
                    clean_ver = current_ver.split('-')[0]
                    new_ver = f"{clean_ver}.{run_num}-DEV"
                    new_line = f"{prefix}{new_ver} (Compiled on {compile_datetime})"
                    content = content.replace(match.group(0), new_line)
                    print(f"Updated {file_path} footer version string.")
                    updated = True

            if updated:
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(content)
            else:
                print(f"Warning: No patterns matched in {file_path}")

    - name: Build Windows Executable
      shell: cmd
      run: |
        call build.bat

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Lyridan-Windows-DEV
        path: dist/*.exe

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        # Install standard requirements, but force 'wrapt' to be built from source
        pip install --no-binary=wrapt -r requirements.txt
        pip uninstall -y tkinterdnd2
        pip install tkinterdnd2-universal
        pip install pyinstaller

    - name: Bump Version and Timestamp
      shell: python
      run: |
        import re
        import os
        from datetime import datetime, timezone

        # --- CONFIGURATION ---
        run_num = os.environ.get('GITHUB_RUN_NUMBER', '0')
        compile_datetime = datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC')

        # --- REGEX PATTERNS ---
        # For maccompile.py: version = "1.1.0"
        mac_ver_pattern = re.compile(r"(version\s*=\s*)(['\"])([^'\"]+)(['\"])", re.IGNORECASE)
        # For maccompile.py: COPYRIGHT = "..."
        copyright_pattern = re.compile(r"(COPYRIGHT\s*=\s*)(['\"])([^'\"]+)(['\"])", re.IGNORECASE)
        # For gui.py: ...version 1.1.0
        gui_ver_pattern = re.compile(r"(Made by Elevatorisbest.*?version\s+)([\d\.]+)")

        # --- FILE PROCESSING ---
        files_to_update = ['gui.py', 'maccompile.py']

        for file_path in files_to_update:
            if not os.path.exists(file_path):
                print(f"Skipping {file_path} (not found)")
                continue
            
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()

            updated = False
            
            # --- Logic for maccompile.py ---
            if 'maccompile.py' in file_path:
                # Update version variable
                match = mac_ver_pattern.search(content)
                if match:
                    prefix, quote_start, current_ver, quote_end = match.groups()
                    clean_ver = current_ver.split('-')[0]
                    new_ver = f"{clean_ver}.{run_num}-DEV"
                    content = content.replace(match.group(0), f"{prefix}{quote_start}{new_ver}{quote_end}")
                    print(f"Updated {file_path} VERSION: {current_ver} -> {new_ver}")
                    updated = True

                # Update copyright with timestamp
                match = copyright_pattern.search(content)
                if match:
                    prefix, quote_start, current_copyright, quote_end = match.groups()
                    new_copyright = f"{current_copyright} | Compiled on {compile_datetime}"
                    content = content.replace(match.group(0), f"{prefix}{quote_start}{new_copyright}{quote_end}")
                    print(f"Updated {file_path} COPYRIGHT with timestamp.")
                    updated = True

            # --- Logic for gui.py ---
            if 'gui.py' in file_path:
                match = gui_ver_pattern.search(content)
                if match:
                    prefix, current_ver = match.groups()
                    # We need the new_ver from the maccompile logic, so let's calculate it again
                    clean_ver = current_ver.split('-')[0]
                    new_ver = f"{clean_ver}.{run_num}-DEV"
                    new_line = f"{prefix}{new_ver} (Compiled on {compile_datetime})"
                    content = content.replace(match.group(0), new_line)
                    print(f"Updated {file_path} footer version string.")
                    updated = True

            if updated:
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(content)
            else:
                print(f"Warning: No patterns matched in {file_path}")


    - name: Build macOS App
      run: |
        python3 maccompile.py

    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Lyridan-MacOS-DEV
        path: dist/*.dmg
