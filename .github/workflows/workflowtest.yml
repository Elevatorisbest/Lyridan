name: Workflow Test Build

on:
  push:
    branches: [ "workflowtest" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetches all history for git versioning

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Bump Version and Timestamp
      shell: python
      run: |
        import os
        import re
        import subprocess
        from datetime import datetime, timezone

        def run_command(command):
            try:
                return subprocess.check_output(command, shell=True, text=True, stderr=subprocess.STDOUT).strip()
            except subprocess.CalledProcessError as e:
                print(f"Command failed: {e.output}")
                return ""

        # 1. Get the core version from the single source of truth
        core_version = None
        try:
            with open('maccompile.py', 'r', encoding='utf-8') as f:
                content = f.read()
                match = re.search(r"VERSION\s*=\s*['\"]([^'\"]+)['\"]", content)
                if match:
                    core_version = match.group(1).split('-')[0]
        except FileNotFoundError:
            print("maccompile.py not found. Skipping version bump.")
        
        if not core_version:
            raise ValueError("Could not read core version from maccompile.py")

        # 2. Determine the build number based on Git history
        current_commit_msg = run_command("git log -1 --pretty=%B")
        build_number = 1

        if '[bump]' in current_commit_msg.lower() or 'version bump' in current_commit_msg.lower():
            build_number = 1
        else:
            last_bump_sha = run_command('git log --grep="\\[bump\\]" --grep="version bump" -n 1 --pretty=format:"%H"')
            if last_bump_sha:
                # Count commits since the last bump + 1
                count = run_command(f'git rev-list --count {last_bump_sha}..HEAD')
                build_number = int(count) + 1 if count.isdigit() else 1
            else:
                # No previous bump commit, count all commits
                count = run_command('git rev-list --count HEAD')
                build_number = int(count) if count.isdigit() else 1
        
        # 3. Construct the new version strings
        new_dev_version = f"{core_version}.{build_number}-DEV"
        compile_datetime = datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC')
        print(f"Determined new version: {new_dev_version}")

        # 4. Update files
        files_to_update = ['gui.py', 'maccompile.py']
        mac_ver_pattern = re.compile(r"(VERSION\s*=\s*)(['\"])([^'\"]+)(['\"])", re.IGNORECASE)
        copyright_pattern = re.compile(r"(COPYRIGHT\s*=\s*)(['\"])([^'\"]+)(['\"])", re.IGNORECASE)
        gui_ver_pattern = re.compile(r"(Made by Elevatorisbest.*?version\s+)([\d\.\w-]+)")

        for file_path in files_to_update:
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
            except FileNotFoundError:
                print(f"Skipping {file_path} (not found)")
                continue

            if 'maccompile.py' in file_path:
                content = mac_ver_pattern.sub(f"\\1\\2{new_dev_version}\\4", content)
                content = copyright_pattern.sub(f"\\1\\2\\3 | Compiled on {compile_datetime}\\4", content)
            
            if 'gui.py' in file_path:
                new_footer = f"\\1{new_dev_version} (Compiled on {compile_datetime})"
                content = gui_ver_pattern.sub(new_footer, content)

            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"Successfully updated versions in {file_path}")

    - name: Build Windows Executable
      shell: cmd
      run: call build.bat

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Lyridan-Windows-DEV
        path: dist/*.exe

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetches all history for git versioning

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install --no-binary=wrapt -r requirements.txt
        pip uninstall -y tkinterdnd2
        pip install tkinterdnd2-universal
        pip install pyinstaller

    - name: Bump Version and Timestamp
      shell: python
      run: |
        import os
        import re
        import subprocess
        from datetime import datetime, timezone

        def run_command(command):
            try:
                return subprocess.check_output(command, shell=True, text=True, stderr=subprocess.STDOUT).strip()
            except subprocess.CalledProcessError as e:
                print(f"Command failed: {e.output}")
                return ""

        # 1. Get the core version from the single source of truth
        core_version = None
        try:
            with open('maccompile.py', 'r', encoding='utf-8') as f:
                content = f.read()
                match = re.search(r"VERSION\s*=\s*['\"]([^'\"]+)['\"]", content)
                if match:
                    core_version = match.group(1).split('-')[0]
        except FileNotFoundError:
            print("maccompile.py not found. Skipping version bump.")
        
        if not core_version:
            raise ValueError("Could not read core version from maccompile.py")

        # 2. Determine the build number based on Git history
        current_commit_msg = run_command("git log -1 --pretty=%B")
        build_number = 1

        if '[bump]' in current_commit_msg.lower() or 'version bump' in current_commit_msg.lower():
            build_number = 1
        else:
            last_bump_sha = run_command('git log --grep="\\[bump\\]" --grep="version bump" -n 1 --pretty=format:"%H"')
            if last_bump_sha:
                # Count commits since the last bump + 1
                count = run_command(f'git rev-list --count {last_bump_sha}..HEAD')
                build_number = int(count) + 1 if count.isdigit() else 1
            else:
                # No previous bump commit, count all commits
                count = run_command('git rev-list --count HEAD')
                build_number = int(count) if count.isdigit() else 1
        
        # 3. Construct the new version strings
        new_dev_version = f"{core_version}.{build_number}-DEV"
        compile_datetime = datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC')
        print(f"Determined new version: {new_dev_version}")

        # 4. Update files
        files_to_update = ['gui.py', 'maccompile.py']
        mac_ver_pattern = re.compile(r"(VERSION\s*=\s*)(['\"])([^'\"]+)(['\"])", re.IGNORECASE)
        copyright_pattern = re.compile(r"(COPYRIGHT\s*=\s*)(['\"])([^'\"]+)(['\"])", re.IGNORECASE)
        gui_ver_pattern = re.compile(r"(Made by Elevatorisbest.*?version\s+)([\d\.\w-]+)")

        for file_path in files_to_update:
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
            except FileNotFoundError:
                print(f"Skipping {file_path} (not found)")
                continue

            if 'maccompile.py' in file_path:
                content = mac_ver_pattern.sub(f"\\1\\2{new_dev_version}\\4", content)
                content = copyright_pattern.sub(f"\\1\\2\\3 | Compiled on {compile_datetime}\\4", content)
            
            if 'gui.py' in file_path:
                new_footer = f"\\1{new_dev_version} (Compiled on {compile_datetime})"
                content = gui_ver_pattern.sub(new_footer, content)

            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"Successfully updated versions in {file_path}")

    - name: Build macOS App
      run: python3 maccompile.py

    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Lyridan-MacOS-DEV
        path: dist/*.dmg
